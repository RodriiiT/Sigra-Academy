<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIGRA | Gestión de Usuarios</title>
  <link rel="stylesheet" href="user-table.css" />
</head>
<body>
  <!-- Navbar superior -->
  <header>
    <nav class="navbar" aria-label="Barra de navegación principal">
      <div class="brand" aria-label="SIGRA">
        <img class="brand-logo" src="../../Public/resources/Modulo-1/logo.png" alt="Logo SIGRA" />
        <span>SIGRA</span>
      </div>

      <div class="nav-links" role="list">
        <a class="active" href="#" role="listitem">Inicio</a>
        <a href="#" role="listitem">Asignaturas</a>
        <a href="#" role="listitem">Docentes</a>
        <a href="#" role="listitem">Reportes</a>
      </div>

      <button class="bell" type="button" aria-label="Notificaciones">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 3.5c-3 0-5.25 2.2-5.25 5.5v2.6c0 .44-.2.86-.55 1.14l-1.07.85c-.18.14-.28.35-.28.57v.84c0 .33.27.6.6.6h13.1c.33 0 .6-.27.6-.6v-.84c0-.22-.1-.43-.28-.57l-1.07-.85c-.35-.28-.55-.7-.55-1.14V9c0-3.3-2.25-5.5-5.25-5.5Z" stroke="currentColor" stroke-width="1.4" />
          <path d="M10.5 18.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" />
        </svg>
      </button>

      <div class="profile-menu" aria-label="Menú de perfil">
        <button class="profile-button" type="button" aria-haspopup="true" aria-expanded="false">
          <span class="profile-avatar" aria-hidden="true">AG</span>
          <span class="sr-only">Abrir menú de perfil</span>
        </button>
      </div>
    </nav>
  </header>

  <!-- Contenido principal -->
  <main>
    <div class="page-header">
      <h1>Dashboard de usuarios</h1>
      <p class="subtitle">Administra y supervisa la actividad de los usuarios en el sistema.</p>
    </div>

    <div class="actions">
      <div class="filters" aria-label="Filtros y buscador">
        <div class="filter-group">
          <label for="role-filter">Rol</label>
          <select id="role-filter" aria-label="Filtrar por rol">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="status-filter">Estado</label>
          <select id="status-filter" aria-label="Filtrar por estado">
            <option value="">Todos</option>
            <option value="active">Activos</option>
            <option value="inactive">Inactivos</option>
          </select>
        </div>
        <div class="filter-group search">
          <label for="search-input">Buscar</label>
          <input id="search-input" type="search" placeholder="Nombre o correo" aria-label="Buscar por nombre o correo" />
        </div>
      </div>
      <button class="ghost-btn" type="button">Agregar usuario nuevo</button>
    </div>

    <!-- Tabla de usuarios -->
    <section class="table-card" aria-label="Tabla de usuarios">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th scope="col">Usuario</th>
              <th scope="col">Rol</th>
              <th scope="col">Estado</th>
              <th scope="col">Correo</th>
              <th scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody id="user-tbody">
            <tr>
              <td colspan="5">Cargando usuarios...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination" aria-label="Paginación de usuarios">
        <a class="page-item icon" href="#" aria-label="Página anterior">&#8249;</a>
        <a class="page-item" href="#">1</a>
        <a class="page-item active" href="#" aria-current="page">2</a>
        <a class="page-item" href="#">3</a>
        <a class="page-item" href="#">4</a>
        <a class="page-item" href="#">5</a>
        <a class="page-item icon" href="#" aria-label="Página siguiente">&#8250;</a>
      </div>
    </section>
  </main>
  <script>
    (() => {
      const API_BASE = 'http://localhost:3000/api/access-control'
      const tbody = document.getElementById('user-tbody')
      const roleFilter = document.getElementById('role-filter')
      const statusFilter = document.getElementById('status-filter')
      const searchInput = document.getElementById('search-input')

      let users = []

      const renderStatus = (isActive) => {
        const active = Boolean(isActive)
        const cls = active ? 'badge active' : 'badge inactive'
        const label = active ? 'Activo' : 'Inactivo'
        return `<span class="${cls}">${label}</span>`
      }

      const renderRow = (u) => {
        const fullName = `${u.first_name || ''} ${u.last_name || ''}`.trim() || 'Sin nombre'
        const mail = u.mail || 'Sin correo'
        const role = u.role_id ?? 'N/D'
        return `
          <tr>
            <td>${fullName}</td>
            <td>${role}</td>
            <td>${renderStatus(u.is_active)}</td>
            <td>${mail}</td>
            <td class="actions-cell">
              <a class="icon-link" href="#" aria-label="Editar usuario">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M4 20h4l9.5-9.5a1.5 1.5 0 0 0 0-2.12l-1.88-1.88a1.5 1.5 0 0 0-2.12 0L4 16v4Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" />
                  <path d="M13.5 6.5 17.5 10.5" stroke="currentColor" stroke-width="1.6" />
                </svg>
              </a>
              <a class="icon-link danger" href="#" aria-label="Eliminar usuario">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M5.5 7h13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                  <path d="M10 10v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                  <path d="M14 10v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                  <path d="M9 7V5.5a1.5 1.5 0 0 1 1.5-1.5h3A1.5 1.5 0 0 1 15 5.5V7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
                  <path d="M6.5 7 7 18a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l.5-11" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" />
                </svg>
              </a>
            </td>
          </tr>
        `
      }

      const renderEmpty = (message) => {
        tbody.innerHTML = `<tr><td colspan="5">${message}</td></tr>`
      }

      const renderTable = () => {
        const roleValue = roleFilter.value
        const statusValue = statusFilter.value
        const term = searchInput.value.trim().toLowerCase()

        const filtered = users.filter((u) => {
          const matchesRole = roleValue === '' || String(u.role_id) === roleValue
          const matchesStatus =
            statusValue === '' || (statusValue === 'active' && Boolean(u.is_active)) || (statusValue === 'inactive' && !Boolean(u.is_active))
          const haystack = `${u.first_name || ''} ${u.last_name || ''} ${u.mail || ''}`.toLowerCase()
          const matchesSearch = term === '' || haystack.includes(term)
          return matchesRole && matchesStatus && matchesSearch
        })

        if (filtered.length === 0) {
          renderEmpty('No hay usuarios con los filtros actuales')
          return
        }

        tbody.innerHTML = filtered.map(renderRow).join('')
      }

      const populateRoles = () => {
        const uniqueRoles = Array.from(new Set(users.map((u) => u.role_id).filter((v) => v !== undefined && v !== null)))
        uniqueRoles.sort((a, b) => Number(a) - Number(b))
        const options = uniqueRoles.map((r) => `<option value="${r}">Rol ${r}</option>`).join('')
        roleFilter.insertAdjacentHTML('beforeend', options)
      }

      const loadUsers = async () => {
        try {
          const res = await fetch(`${API_BASE}/users`)
          if (!res.ok) throw new Error('No se pudo obtener la lista de usuarios')
          const data = await res.json()
          users = Array.isArray(data) ? data : []
          populateRoles()
          renderTable()
        } catch (error) {
          console.error('Error cargando usuarios:', error)
          renderEmpty('No se pudo cargar la lista de usuarios')
        }
      }

      roleFilter.addEventListener('change', renderTable)
      statusFilter.addEventListener('change', renderTable)
      searchInput.addEventListener('input', renderTable)

      loadUsers()
    })()
  </script>
</body>
</html>
